<!-- First, the content of the edit dialog is defined.                       -->
<style>
  .form-row.checkbox > input[type="checkbox"] {
    width:10%;
  }

  .form-row.checkbox > label {
    width:80%;
  }
</style>

<script type="text/x-red" data-template-name="sensorTag">
     <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
      <label for="node-input-topic"><i class="icon-tag"></i> Topic</label>
      <input type="text" id="node-input-topic" placeholder="Topic">
    </div>
    <div class="form-row">
      <label for="node-input-uuid"><i class="icon-tag"></i> UUID</label>
      <input type="text" id="node-input-uuid" placeholder="UUID">
    </div>
    <h5>Sensors</h5>
    <div class="form-row">
      <a href="#" class="btn btn-mini" id="node-input-disableAll"><i class="icon-remove"></i> Disable All</a>&nbsp;
      <a href="#" class="btn btn-mini" id="node-input-enableAll"><i class="icon-ok"></i> Enable All</a>
    </div>
    <div class="form-row checkbox">
      <input type="checkbox" id="node-input-temperature">
      <label for="node-input-temperature">Temperature</label>
    </div>
    <div class="form-row checkbox">
      <input type="checkbox" id="node-input-humidity">
      <label for="node-input-humidity">Humidity</label>
    </div>
    <div class="form-row checkbox">
      <input type="checkbox" id="node-input-pressure">
      <label for="node-input-pressure">Pressure</label>
    </div>
    <div class="form-row checkbox">
      <input type="checkbox" id="node-input-magnetometer">
      <label for="node-input-magnetometer">Magnetometer</label>
      <div class="form-row">
        <label for="node-input-magnetometerPeriod"><i class="icon-time"></i> Period</label>
        <input id="node-input-magnetometerPeriod" type="text">
      </div>
    </div>
    <div class="form-row checkbox">
      <input type="checkbox" id="node-input-accelerometer">
      <label for="node-input-accelerometer">Accelerometer</label>
      <div class="form-row">
        <label for="node-input-accelerometerPeriod"><i class="icon-time"></i> Period</label>
        <input id="node-input-accelerometerPeriod" type="text">
      </div>
    </div>
    <div class="form-row checkbox">
      <input type="checkbox" id="node-input-gyroscope">
      <label for="node-input-gyroscope">Gyroscope</label>
      <div class="form-row">
        <label for="node-input-gyroscopePeriod"><i class="icon-time"></i> Period</label>
        <input id="node-input-gyroscopePeriod" type="text">
      </div>
    </div>
    <div class="form-row checkbox">
      <input type="checkbox" id="node-input-luxometer">
      <label for="node-input-luxometer">Luxometer (CC2650 only)</label>
      <div class="form-row">
        <label for="node-input-luxometerPeriod"><i class="icon-time"></i> Period</label>
        <input id="node-input-luxometerPeriod" type="text">
      </div>
    </div>
    <div class="form-row checkbox">
      <input type="checkbox" id="node-input-keys">
      <label for="node-input-keys">Keys</label>
    </div>
</script>


<!-- Next, some simple help text is provided for the node.                   -->
<script type="text/x-red" data-help-name="sensorTag">
   <!-- data-help-name identifies the node type this help is for             -->
   <!-- This content appears in the Info sidebar when a node is selected     -->
   <!-- The first <p> is used as the pop-up tool tip when hovering over a    -->
   <!-- node in the palette.                                                 -->
   <p>Input node for the Ti SensorTag</p>
   <p>For this node to work correctly Node-Red needs to be run as root, this
      due to how Bluetooth 4.0 support is currently implemented in Linux</p>
   <p>The UUID field is the mac address of the sensor tag, this is optional
      can be used to bind to a specific SensorTag if you have more than one
      active in range at the same time. (note you can only have one SensorTag
      per node-red instance at the moment)</p>
   <p>The topic setting is a prefix that will be pre-pended to name of the
      sensor that creates the reading. e.g. <i>sensorTag/temperature</i></p>
</script>

<script type="text/javascript">
    function setPeriodVisibility( $checkbox )
    {
      var $period = $checkbox.siblings( ".form-row" );
      if( $period.length < 1 ) return;
      if( $checkbox.prop( "checked" ) )
      {
        $period.show();
      }
      else
      {
        $period.hide();
      }
    }

    function positiveNumber( v )
    {
      if( v === "" ) return true;
      return ( !isNaN( v ) && v > 0 );
    }

    RED.nodes.registerType('sensorTag',{
        category: 'advanced-function',
        color:"GoldenRod",
        defaults: {             // defines the editable properties of the node
            name: { value : "sensorTag" },   //  along with default values.
            topic: { value : "sensorTag" },
            uuid: { value : "" },
            temperature: { value : true },
            humidity: { value : true },
            pressure: { value : true },
            magnetometer: { value : true },
            magnetometerPeriod : { value : 1000 , validate : positiveNumber },
            accelerometer: { value : true },
            accelerometerPeriod : {value : 1000 , validate : positiveNumber },
            gyroscope: { value : true },
            gyroscopePeriod : { value : 1000 , validate : positiveNumber },
            luxometer : { value : true },
            luxometerPeriod : { value : 1000 , validate : positiveNumber },
            keys: { value : true }
        },
        inputs:0,                // set the number of inputs - only 0 or 1
        outputs:1,               // set the number of outputs - 0 to n
        icon: "bluetooth.png",    // set the icon (held in public/icons)
        label: function() {      // sets the default label contents
            return this.name||this.topic||"sensorTag";
        },
        labelStyle: function() { // sets the class to apply to the label
            return this.name?"node_label_italic":"";
        },
        oneditsave: function() {
           var mac = $("#node-input-uuid").val();
           mac = mac.replace(/:/gi,'');
           mac = mac.toLowerCase();
           $("#node-input-uuid").val(mac);

           // Clear hidden periods
           $( ".form-row.checkbox > .form-row" ).each( function() {
             if( $( this ).css( "display" ) === "none" )
             {
               $( this ).find( "input" ).val( "" );
             }
           } );

        },

        oneditprepare: function() {
          var $checkboxes = $( ".form-row.checkbox > input" );
          
          for( var i = 0; i < $checkboxes.length; i++ )
          {
            setPeriodVisibility( $( $checkboxes[i] ) );
          }

          $checkboxes.on( "change" , function() {
            setPeriodVisibility( $( this ) );
          } );

          $( "#node-input-disableAll" ).on( "click" , function( event ) {
            event.preventDefault();
            $checkboxes.prop( "checked" , false ).trigger( "change" );
          } );

          $( "#node-input-enableAll" ).on( "click" , function( event ) {
            event.preventDefault();
            $checkboxes.prop( "checked" , true ).trigger( "change" );
          } );
        },
		button: {
		  toggle: "active",
          onclick: function() {
              var label = this.name||"sensorTag";
              d3.xhr("sensorTag/"+this.id+"/").post(function(err,resp) {
                  if (err) {
                      if (err.status == 404) {
                          RED.notify("<strong>Error</strong>: sensorTag node not deployed","error");
                      } else if (err.status == 0) {
                          RED.notify("<strong>Error</strong>: no response from server","error");
                      } else {
                          RED.notify("<strong>Error</strong>: unexpected error: ("+err.status+")"+err.response,"error");
                      }
                  } else if (resp.status == 200) {
                      RED.notify("Successfully activated: "+label,"success");
                  } else if (resp.status == 201) {
                      RED.notify("Successfully deactivated: "+label,"success");
                  } else {
                      RED.notify("<strong>Error</strong>: unexpected response: ("+resp.status+") "+resp.response,"error");
                  }
              });
          }
        }
    });
</script>
